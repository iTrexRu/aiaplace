name: Deploy facontai (NEW SFTP)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Локальная проверка: что реально есть в repo на раннере
      - name: Debug - verify local source files
        shell: bash
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "Top level:"
          ls -la
          echo "facont folder exists?"
          test -d facont && echo "OK: facont/ exists" || (echo "ERROR: facont/ missing" && exit 1)
          echo "Count files under facont/:"
          find facont -type f | wc -l
          echo "Sample files:"
          find facont -type f | head -n 50

      # 2) Деплой: заливаем содержимое facont/ в корень на новом сервере
      - name: Deploy facont to NEW server (SFTP password)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          source: "facont/**"
          target: ${{ secrets.SFTP_SERVER_DIR }}
          strip_components: 1
          overwrite: true
          debug: true

      # 3) Проверка на сервере: есть ли файлы там, куда ты деплоишь
      - name: Post-deploy check (remote)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            echo "WHOAMI=$(whoami)"
            echo "PWD=$(pwd)"
            echo "---- TARGET DIR ----"
            echo "${{ secrets.SFTP_SERVER_DIR }}"
            echo "---- ls TARGET ----"
            ls -la "${{ secrets.SFTP_SERVER_DIR }}" || true
            echo "---- find known files in TARGET (maxdepth 4) ----"
            find "${{ secrets.SFTP_SERVER_DIR }}" -maxdepth 4 \
              \( -name "home.html" -o -name "login.html" -o -name "facont.css" -o -name "facont.js" -o -name "404.html" \) \
              -print 2>/dev/null | head -n 100
