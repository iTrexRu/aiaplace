name: Deploy facontai (NEW SFTP)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SFTP_SERVER: ${{ secrets.SFTP_SERVER }}
      SFTP_PORT: ${{ secrets.SFTP_PORT }}
      SFTP_USER: ${{ secrets.SFTP_USER }}
      SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      SFTP_SERVER_DIR: ${{ secrets.SFTP_SERVER_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy facont (SFTP password)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USER }}
          password: ${{ env.SFTP_PASSWORD }}
          port: ${{ env.SFTP_PORT }}
          source: "facont/**"
          target: ${{ env.SFTP_SERVER_DIR }}
          strip_components: 1
          overwrite: true
          debug: true

      - name: Post-deploy check (remote)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USER }}
          password: ${{ env.SFTP_PASSWORD }}
          port: ${{ env.SFTP_PORT }}
          script: |
            set -e
            echo "WHOAMI=$(whoami)"
            echo "PWD=$(pwd)"
            echo "TARGET=$SFTP_SERVER_DIR"
            echo "---- ls TARGET ----"
            ls -la "$SFTP_SERVER_DIR" || true
            echo "---- ls TARGET/facont ----"
            ls -la "$SFTP_SERVER_DIR/facont" || true
            echo "---- find known files (maxdepth 5) ----"
            find "$SFTP_SERVER_DIR" -maxdepth 5 \( -name "login.html" -o -name "onboarding-overview.html" -o -name "index.html" \) -print 2>/dev/null | head -n 50
