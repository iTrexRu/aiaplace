name: Deploy facontai (NEW SFTP)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - verify local source files
        shell: bash
        run: |
          set -e
          test -d facont || (echo "ERROR: facont/ missing" && exit 1)
          echo "Count files under facont/:"
          find facont -type f | wc -l
          echo "Sample:"
          find facont -type f | head -n 30

      - name: Deploy to ABSOLUTE docroot
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          source: "facont/**"
          target: ${{ secrets.SFTP_SERVER_DIR }}
          strip_components: 1
          overwrite: true
          debug: true

      - name: Post-deploy check (remote, absolute paths)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            echo "WHOAMI=$(whoami)"
            echo "PWD=$(pwd)"

            echo "ABS_TARGET=${{ secrets.SFTP_SERVER_DIR }}"
            echo "---- test ABS_TARGET ----"
            if [ -d "${{ secrets.SFTP_SERVER_DIR }}" ]; then
              echo "OK: target exists"
            else
              echo "ERROR: target does NOT exist"
              exit 1
            fi

            echo "---- ls ABS_TARGET ----"
            ls -la "${{ secrets.SFTP_SERVER_DIR }}" | head -n 120

            echo "---- ls ABS_TARGET/app ----"
            ls -la "${{ secrets.SFTP_SERVER_DIR }}/app" | head -n 80 || true

            echo "---- find key files ----"
            find "${{ secrets.SFTP_SERVER_DIR }}" -maxdepth 2 \
              \( -name "index.html" -o -name "index.php" -o -name "home.html" -o -name "login.html" -o -name "*.css" -o -name "*.js" \) \
              -print 2>/dev/null | head -n 200
