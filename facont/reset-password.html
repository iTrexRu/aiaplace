<div class="facont-login-page">
  <div class="facont-login-card">
    <h1>Новый пароль</h1>
    <p>Придумайте новый надежный пароль.</p>
    <form id="facont-reset-form" class="facont-login-form">
      <div class="facont-field">
        <label for="reset-password">Новый пароль</label>
        <input type="password" id="reset-password" name="password" autocomplete="new-password" required minlength="8">
      </div>
      <div class="facont-field">
        <label for="reset-confirm">Повторите пароль</label>
        <input type="password" id="reset-confirm" name="confirm" autocomplete="new-password" required minlength="8">
      </div>

      <div class="facont-login-actions" style="flex-direction: column; align-items: flex-start; gap: 12px;">
        <button type="submit" class="facont-btn-primary" style="width:100%">Сохранить пароль</button>
      </div>
      <div id="reset-error" class="facont-login-error" role="alert"></div>
      <div id="reset-success" style="color:green; margin-top:12px; display:none;">
        Пароль изменен! <a href="/facont/" style="color:#2563eb; text-decoration:underline;">Войти</a>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById('facont-reset-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    
    const password = document.getElementById('reset-password').value;
    const confirm = document.getElementById('reset-confirm').value;
    const errorEl = document.getElementById('reset-error');
    const successEl = document.getElementById('reset-success');
    const btn = this.querySelector('button');

    if (!token) {
      errorEl.textContent = 'Ошибка: Токен не найден в ссылке.';
      return;
    }

    if (password !== confirm) {
      errorEl.textContent = 'Пароли не совпадают.';
      return;
    }

    btn.disabled = true;
    errorEl.textContent = '';
    successEl.style.display = 'none';

    try {
      // URL API тот же, что и везде
      const API_URL = 'https://itrex-auto-prod.up.railway.app/webhook/d3499289-9710-47bc-bd72-8aa9ccbd1426';

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          cmd: 'auth_reset_password', 
          token, 
          password 
        })
      });

      const data = await res.json();

      if (data.ok) {
        successEl.style.display = 'block';
        this.reset();
      } else {
        throw new Error(data.message || 'Ошибка сброса пароля (возможно, ссылка устарела).');
      }
    } catch (err) {
      errorEl.textContent = err.message;
    } finally {
      btn.disabled = false;
    }
  });
</script>